# 文件选择器工作流

## 概述
文件选择器负责显示目录结构、管理文件选择状态，并返回用户选中的文件列表。

## 核心功能

### 文件加载
- 扫描指定目录下的所有文件和子目录
- 按名称排序显示文件列表
- 支持文件类型图标显示
- 提供加载状态反馈

### 选择管理
- 支持多选模式（默认启用）
- 提供全选/取消全选功能
- 支持反选操作
- 单个文件切换选择状态

### 导航控制
- 上下键移动光标
- 空格键切换选择状态
- Enter键确认选择
- Esc键取消并返回

## 工作流程

### 1. 初始化阶段
```
NewFileSelectorModel(path) -> Init() -> loadFiles() -> FileListMsg
```

### 2. 文件加载流程
```
loadFiles() -> 扫描目录 -> 排序文件 -> 转换为FileItem -> 发送FileListMsg
```

### 3. 用户交互流程
```
键盘输入 -> Update() -> 处理按键逻辑 -> 更新状态 -> View()重新渲染
```

### 4. 选择确认流程
```
Enter键 -> confirmSelection() -> 收集选中项 -> FileSelectionMsg -> 返回主界面
```

## 状态管理

### 内部状态
- `path`: 当前浏览路径
- `items`: 文件项列表
- `selected`: 选中状态映射
- `cursor`: 当前光标位置
- `scrollOffset`: 滚动偏移量
- `multiSelect`: 多选模式开关
- `filter`: 过滤条件

### 显示控制
- 计算可见区域高度
- 管理滚动偏移
- 分页信息显示
- 文件项渲染

## 键盘映射

| 按键 | 功能 |
|------|------|
| ↑/k | 向上移动光标 |
| ↓/j | 向下移动光标 |
| 空格 | 切换选择状态 |
| a | 全选 |
| n | 取消全选 |
| i | 反选 |
| / | 进入搜索模式 |
| Enter | 确认选择 |
| Esc | 取消并返回 |
| Ctrl+C/q | 退出程序 |

## 渲染逻辑

### 文件项显示
- 显示文件图标（文件夹📂、文件📄等）
- 显示文件名称
- 显示选择状态标记
- 光标高亮当前项

### 信息展示
- 当前路径显示
- 分页信息（显示范围/总数）
- 操作帮助提示
- 加载状态提示

## 已知问题分析

### 文件列表加载失败
**可能原因：**
1. 目录扫描权限问题
2. 文件系统访问异常
3. 文件项转换错误
4. 大量文件导致内存问题

**测试要点：**
1. 测试不同权限的目录访问
2. 测试大量文件的加载性能
3. 测试特殊字符文件名处理
4. 测试网络路径访问

### 性能优化建议
1. 实现虚拟滚动，只渲染可见区域
2. 添加文件类型过滤功能
3. 支持异步文件加载
4. 添加文件大小显示

## 测试场景

### 基本功能测试
- 空目录显示
- 单文件选择
- 多文件选择
- 全选/取消全选
- 反选操作

### 边界条件测试
- 大量文件（>1000个）
- 深层目录结构
- 特殊字符文件名
- 权限受限目录

### 交互测试
- 键盘响应速度
- 滚动流畅性
- 状态切换正确性
- 返回数据完整性