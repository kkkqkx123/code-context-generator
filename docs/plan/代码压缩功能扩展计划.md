# 代码压缩功能扩展计划

## 功能概述

基于repomix的代码压缩功能，为项目添加智能代码压缩能力，通过Tree-sitter等技术提取关键代码元素，减少Token消耗同时保持代码结构完整性。

## 当前状态分析

### 现有功能
- ❌ 无代码压缩功能
- ❌ 无法优化Token使用
- ❌ 缺少结构保留机制

### 与repomix对比
- ❌ 缺少Tree-sitter集成
- ❌ 缺少智能代码提取
- ❌ 缺少压缩级别控制

## 扩展目标

### 核心功能
1. **智能代码解析** - 基于语法分析的代码理解
2. **结构保留压缩** - 保持代码逻辑结构
3. **多语言支持** - 主流编程语言支持
4. **压缩级别控制** - 可配置的压缩强度

### 压缩策略
- **函数签名保留** - 保持接口完整性
- **注释精简** - 保留关键注释
- **实现省略** - 选择性省略实现细节
- **导入优化** - 智能导入语句处理

## 技术实现方案

### 1. Tree-sitter集成

#### 核心架构
```go
type CodeCompressor struct {
    parsers map[string]*sitter.Parser
    compressionLevel CompressionLevel
}

type CompressionLevel int

const (
    CompressionMinimal CompressionLevel = iota  // 最小压缩
    CompressionBalanced                          // 平衡压缩
    CompressionAggressive                       // 激进压缩
)
```

#### 支持的编程语言
- **Go** - 原生支持
- **JavaScript/TypeScript**
- **Python**
- **Java**
- **C/C++**
- **Rust**
- **更多语言逐步支持**

### 2. 智能代码提取算法

#### 压缩策略
```go
type CompressionStrategy struct {
    PreserveFunctionSignatures bool    `json:"preserve_function_signatures"`
    PreserveClassDefinitions   bool    `json:"preserve_class_definitions"`
    PreserveImportStatements   bool    `json:"preserve_import_statements"`
    PreserveComments           bool    `json:"preserve_comments"`
    MaxImplementationLines     int     `json:"max_implementation_lines"`
    EllipsisMarker             string  `json:"ellipsis_marker"`
}
```

#### 压缩示例
**原始代码**:
```go
package main

import (
    "fmt"
    "strings"
)

// CalculateSum calculates the sum of two numbers
func CalculateSum(a, b int) int {
    result := a + b
    return result
}

// ComplexFunction demonstrates a more complex implementation
func ComplexFunction(input string) string {
    // Multiple steps of processing
    step1 := strings.ToLower(input)
    step2 := strings.TrimSpace(step1)
    step3 := strings.ReplaceAll(step2, "old", "new")
    
    // Additional complex logic
    if len(step3) > 100 {
        step3 = step3[:100] + "..."
    }
    
    return step3
}
```

**压缩后代码**:
```go
package main

import (
    "fmt"
    "strings"
)

// CalculateSum calculates the sum of two numbers
func CalculateSum(a, b int) int {
⋮----
}

// ComplexFunction demonstrates a more complex implementation
func ComplexFunction(input string) string {
⋮----
}
```

### 3. 压缩级别控制

#### 级别定义
- **Minimal**: 仅压缩大型函数实现
- **Balanced**: 平衡压缩，保留关键结构
- **Aggressive**: 最大压缩，仅保留接口

#### 配置示例
```yaml
compression:
  enabled: false
  level: "balanced"  # minimal, balanced, aggressive
  strategies:
    go:
      preserve_function_signatures: true
      preserve_comments: true
      max_implementation_lines: 10
      ellipsis_marker: "⋮----"
    javascript:
      preserve_function_signatures: true
      preserve_import_statements: true
      max_implementation_lines: 5
```

### 4. Token节省统计

#### 统计功能
```go
type CompressionStats struct {
    OriginalTokens   int     `json:"original_tokens"`
    CompressedTokens int     `json:"compressed_tokens"`
    SavingsPercent   float64 `json:"savings_percent"`
    FilesProcessed   int     `json:"files_processed"`
    LanguageStats    map[string]LanguageStats `json:"language_stats"`
}

type LanguageStats struct {
    FilesCount      int     `json:"files_count"`
    OriginalTokens  int     `json:"original_tokens"`
    CompressedTokens int    `json:"compressed_tokens"`
    AvgSavings     float64 `json:"avg_savings"`
}
```

## 实施步骤

### 第一阶段：基础功能（3周）
1. **Tree-sitter集成**
   - 集成Go语言解析器
   - 实现基础代码解析
   - 测试解析准确性

2. **压缩算法开发**
   - 实现函数签名提取
   - 开发注释处理逻辑
   - 实现省略标记插入

### 第二阶段：多语言支持（2周）
3. **语言扩展**
   - 支持JavaScript/TypeScript
   - 支持Python
   - 语言特定优化

4. **压缩级别实现**
   - 三级压缩策略
   - 配置系统集成
   - 性能优化

### 第三阶段：高级功能（2周）
5. **统计和报告**
   - Token节省统计
   - 压缩效果报告
   - 优化建议生成

6. **用户体验优化**
   - 命令行界面
   - 错误处理
   - 文档完善

## 代码架构

### 新增包结构
```
internal/compression/
├── compressor.go          # 压缩器主接口
├── tree_sitter_integration.go # Tree-sitter集成
├── strategies.go         # 压缩策略
├── language_support.go    # 多语言支持
└── stats.go               # 统计功能

internal/compression/languages/
├── go_compressor.go       # Go语言压缩器
├── javascript_compressor.go # JavaScript压缩器
├── python_compressor.go   # Python压缩器
└── generic_compressor.go  # 通用压缩器

pkg/types/
├── compression_config.go # 压缩配置
└── compression_stats.go  # 压缩统计
```

### 依赖管理
- **核心依赖**: `github.com/tree-sitter/go-tree-sitter`
- **语言解析器**: 各语言Tree-sitter语法定义
- **可选依赖**: 系统级Tree-sitter（性能优化）

## 配置变更

### 新增配置项
```yaml
compression:
  enabled: false
  level: "balanced"  # minimal, balanced, aggressive
  fallback_to_generic: true  # 无法解析时使用通用压缩
  
  # 语言特定配置
  languages:
    go:
      enabled: true
      strategy: "balanced"
    javascript:
      enabled: true
      strategy: "balanced"
    python:
      enabled: true
      strategy: "minimal"
    
  # 通用压缩策略
  strategy:
    preserve_function_signatures: true
    preserve_class_definitions: true
    preserve_import_statements: true
    preserve_comments: true
    max_implementation_lines: 10
    ellipsis_marker: "⋮----"
    
  # 统计和报告
  stats:
    enabled: true
    show_savings: true
    detailed_report: false
```

## 命令行参数

### 新增参数
```bash
# 压缩功能
--compress                    # 启用代码压缩
--compression-level <level>  # 压缩级别
--no-compression              # 禁用压缩（覆盖配置）

# 语言特定选项
--compress-go                 # 仅压缩Go文件
--compress-js                 # 仅压缩JavaScript文件
--compress-python            # 仅压缩Python文件

# 统计和报告
--show-compression-stats     # 显示压缩统计
--compression-report <file>  # 生成压缩报告
```

## 输出格式集成

### 压缩标记集成
在输出文件中使用统一标记表示压缩部分：

```xml
<file path="src/main.go">
  <compression_info>
    <original_size>1024</original_size>
    <compressed_size>512</compressed_size>
    <savings_percent>50.0</savings_percent>
  </compression_info>
  <content>
package main

import "fmt"

func main() {
⋮----
}
  </content>
</file>
```

## 测试策略

### 单元测试
- 代码解析准确性测试
- 压缩算法逻辑测试
- 边界条件处理测试

### 集成测试
- 真实代码库压缩测试
- 多语言兼容性测试
- 压缩效果验证测试

### 性能测试
- 压缩速度基准测试
- 内存使用测试
- 大文件处理测试

## 性能考虑

### 优化策略
- **缓存**: 解析结果缓存
- **并行**: 多文件并行压缩
- **增量**: 只处理变更文件
- **懒加载**: 按需加载解析器

### 资源管理
- 控制并发数量
- 内存使用监控
- 超时处理机制

## 风险评估

### 技术风险
- Tree-sitter解析准确性
- 多语言支持复杂性
- 性能影响评估

### 缓解措施
- 备用通用压缩算法
- 渐进式功能启用
- 性能监控和限制

## 成功指标

### 功能指标
- 支持5+编程语言
- Token节省率>30%
- 压缩准确率>95%

### 性能指标
- 压缩速度可接受
- 内存使用可控
- 稳定性良好

## 后续扩展

### 短期扩展
- 更多编程语言支持
- 智能代码重构建议
- 压缩预览功能

### 长期扩展
- AI驱动的压缩优化
- 代码质量分析集成
- 自动化重构工具