# 安全扫描功能扩展计划

## 功能概述

基于repomix的安全检查功能，为项目添加代码安全扫描能力，检测潜在的安全漏洞、敏感信息泄露和代码质量问题。

## 当前状态分析

### 现有功能
- ❌ 无安全扫描功能
- ❌ 无法检测敏感信息
- ❌ 缺少代码质量检查

### 与repomix对比
- ❌ 缺少安全检查控制
- ❌ 缺少敏感信息检测
- ❌ 缺少安全报告生成

## 扩展目标

### 核心功能
1. **敏感信息检测** - API密钥、密码、令牌等
2. **安全漏洞扫描** - 常见代码安全漏洞
3. **代码质量检查** - 最佳实践和规范检查
4. **安全报告生成** - 详细的安全评估报告

### 安全检测类型
- **硬编码凭证** - API密钥、密码、令牌
- **敏感配置** - 数据库连接字符串、密钥文件
- **安全漏洞** - SQL注入、XSS、路径遍历
- **代码质量** - 未使用的变量、错误处理

## 技术实现方案

### 1. 安全扫描引擎

#### 核心架构
```go
type SecurityScanner struct {
    detectors []SecurityDetector
    config    SecurityConfig
    reporter  SecurityReporter
}

type SecurityDetector interface {
    Detect(filePath string, content string) []SecurityIssue
    GetName() string
    GetSeverity() SeverityLevel
}

type SeverityLevel int

const (
    SeverityLow SeverityLevel = iota
    SeverityMedium
    SeverityHigh
    SeverityCritical
)
```

#### 检测器类型
- **正则检测器** - 基于模式匹配的检测
- **语法检测器** - 基于语法分析的检测
- **语义检测器** - 基于代码理解的检测

### 2. 检测规则库

#### 硬编码凭证检测
```go
// API密钥模式
var apiKeyPatterns = []string{
    `(?i)(api[_-]?key)[\s]*[=:][\s]*['\"]([a-zA-Z0-9]{20,50})['\"]`,
    `(?i)(secret[_-]?key)[\s]*[=:][\s]*['\"]([a-zA-Z0-9]{20,50})['\"]`,
    `(?i)(access[_-]?token)[\s]*[=:][\s]*['\"]([a-zA-Z0-9]{20,50})['\"]`,
}

// 密码模式
var passwordPatterns = []string{
    `(?i)(password|pwd)[\s]*[=:][\s]*['\"]([^'\"]{6,50})['\"]`,
    `(?i)(db[_-]?password)[\s]*[=:][\s]*['\"]([^'\"]{6,50})['\"]`,
}
```

#### 安全漏洞检测
```go
// SQL注入检测
func detectSQLInjection(content string) []SecurityIssue {
    var issues []SecurityIssue
    
    // 检测字符串拼接的SQL查询
    patterns := []string{
        `(?i)SELECT\s.*\+.*FROM`,
        `(?i)INSERT\s.*\+.*INTO`,
        `(?i)UPDATE\s.*\+.*SET`,
        `(?i)DELETE\s.*\+.*FROM`,
    }
    
    for _, pattern := range patterns {
        if regexp.MustCompile(pattern).MatchString(content) {
            issues = append(issues, SecurityIssue{
                Type:     "SQL Injection",
                Severity: SeverityHigh,
                Message:  "Potential SQL injection vulnerability detected",
                Location: findLineNumber(content, pattern),
            })
        }
    }
    
    return issues
}
```

### 3. 配置系统

#### 安全配置结构
```go
type SecurityConfig struct {
    Enabled          bool              `json:"enabled"`
    FailOnCritical   bool              `json:"fail_on_critical"`
    ScanLevel        ScanLevel         `json:"scan_level"`
    
    Detectors        DetectorConfig    `json:"detectors"`
    Exclusions       ExclusionConfig   `json:"exclusions"`
    Reporting        ReportingConfig   `json:"reporting"`
}

type ScanLevel int

const (
    ScanLevelBasic ScanLevel = iota    // 基础扫描
    ScanLevelStandard                  // 标准扫描
    ScanLevelComprehensive             // 全面扫描
)
```

#### 检测器配置
```yaml
security:
  enabled: false
  fail_on_critical: true
  scan_level: "standard"  # basic, standard, comprehensive
  
  detectors:
    # 敏感信息检测
    hardcoded_credentials:
      enabled: true
      severity_threshold: "medium"
      patterns:
        - "api_key"
        - "secret_key"
        - "access_token"
        - "password"
    
    # 安全漏洞检测
    sql_injection:
      enabled: true
      severity_threshold: "high"
    
    xss_vulnerabilities:
      enabled: true
      severity_threshold: "high"
    
    path_traversal:
      enabled: true
      severity_threshold: "medium"
    
    # 代码质量检测
    unused_variables:
      enabled: false
      severity_threshold: "low"
    
    error_handling:
      enabled: true
      severity_threshold: "medium"
  
  # 排除配置
  exclusions:
    files:
      - "**/test/**"
      - "**/vendor/**"
      - "**/node_modules/**"
    
    patterns:
      - "test.*"
      - "mock.*"
    
    # 特定排除规则
    rules:
      - pattern: "API_KEY_TEST"
        reason: "测试环境变量"
      - pattern: "password.*test"
        reason: "测试密码"
  
  # 报告配置
  reporting:
    format: "text"  # text, json, html, sarif
    output_file: "security_report.txt"
    include_details: true
    show_statistics: true
```

### 4. 报告系统

#### 安全报告结构
```go
type SecurityReport struct {
    ScanID        string          `json:"scan_id"`
    Timestamp     time.Time       `json:"timestamp"`
    ScanDuration  time.Duration   `json:"scan_duration"`
    
    Summary       ScanSummary     `json:"summary"`
    Issues        []SecurityIssue `json:"issues"`
    Statistics    ScanStatistics  `json:"statistics"`
    
    Config        SecurityConfig  `json:"config"`
}

type ScanSummary struct {
    TotalFiles        int `json:"total_files"`
    ScannedFiles      int `json:"scanned_files"`
    IssuesFound       int `json:"issues_found"`
    CriticalIssues   int `json:"critical_issues"`
    HighIssues       int `json:"high_issues"`
    MediumIssues     int `json:"medium_issues"`
    LowIssues        int `json:"low_issues"`
}
```

## 实施步骤

### 第一阶段：基础检测（3周）
1. **核心检测器开发**
   - 硬编码凭证检测
   - 基础安全漏洞检测
   - 配置系统集成

2. **报告系统实现**
   - 文本格式报告
   - 基础统计功能
   - 命令行集成

### 第二阶段：高级检测（2周）
3. **高级检测器**
   - 语法分析检测
   - 代码质量检查
   - 多语言支持

4. **报告格式扩展**
   - JSON格式报告
   - HTML可视化报告
   - SARIF格式支持

### 第三阶段：优化集成（2周）
5. **性能优化**
   - 并行扫描优化
   - 缓存机制实现
   - 增量扫描支持

6. **用户体验**
   - 交互式扫描
   - 自动修复建议
   - 文档完善

## 代码架构

### 新增包结构
```
internal/security/
├── scanner.go           # 安全扫描器主接口
├── detectors/          # 检测器实现
│   ├── credential_detector.go    # 凭证检测
│   ├── vulnerability_detector.go # 漏洞检测
│   ├── quality_detector.go       # 质量检测
│   └── pattern_matcher.go        # 模式匹配
├── config/             # 配置管理
│   ├── security_config.go
│   └── rule_loader.go
├── reporting/          # 报告系统
│   ├── reporter.go
│   ├── text_reporter.go
│   ├── json_reporter.go
│   ├── html_reporter.go
│   └── sarif_reporter.go
└── types/             # 类型定义
    ├── security_issue.go
    ├── scan_result.go
    └── severity.go

pkg/types/
├── security_config.go  # 安全配置类型
└── security_report.go  # 安全报告类型
```

### 依赖管理
- **核心依赖**: 标准库正则表达式
- **可选依赖**: 语法分析库（高级检测）
- **报告格式**: 模板引擎（HTML报告）

## 命令行参数

### 新增参数
```bash
# 安全扫描功能
--security-scan              # 启用安全扫描
--no-security-scan          # 禁用安全扫描（覆盖配置）
--fail-on-critical          # 发现严重问题时失败
--scan-level <level>       # 扫描级别

# 检测器控制
--enable-detector <name>    # 启用特定检测器
--disable-detector <name>   # 禁用特定检测器
--severity-threshold <level> # 严重性阈值

# 报告选项
--security-report <file>    # 生成安全报告
--report-format <format>    # 报告格式
--include-details          # 包含详细信息

# 排除选项
--exclude-files <pattern>   # 排除文件模式
--exclude-patterns <regex>  # 排除内容模式
```

## 输出集成

### 控制台输出
```bash
Security Scan Results:
════════════════════════════════════════════════════════════════════════════════

📊 Scan Summary:
   Files Scanned: 156
   Issues Found: 12 (1 Critical, 3 High, 5 Medium, 3 Low)
   Scan Duration: 2.3s

🔴 Critical Issues (1):
   • config/database.go:45 - Hardcoded database password detected

🟡 High Issues (3):
   • src/api/user.go:23 - Potential SQL injection vulnerability
   • src/utils/crypto.go:67 - Weak encryption algorithm used
   • config/app.go:89 - API key exposed in configuration

✅ Recommendations:
   • Move sensitive data to environment variables
   • Use parameterized queries for database operations
   • Implement proper error handling
```

### 报告文件示例
```json
{
  "scan_id": "scan_20240115_143022",
  "timestamp": "2024-01-15T14:30:22Z",
  "scan_duration": "2.3s",
  "summary": {
    "total_files": 156,
    "scanned_files": 156,
    "issues_found": 12,
    "critical_issues": 1,
    "high_issues": 3,
    "medium_issues": 5,
    "low_issues": 3
  },
  "issues": [
    {
      "type": "Hardcoded Credential",
      "severity": "critical",
      "message": "Hardcoded database password detected",
      "file": "config/database.go",
      "line": 45,
      "snippet": "password: \"mysecretpassword123\"",
      "recommendation": "Use environment variables for sensitive data"
    }
  ]
}
```

## 测试策略

### 单元测试
- 检测器逻辑测试
- 模式匹配准确性测试
- 边界条件处理测试

### 集成测试
- 真实代码库扫描测试
- 多文件类型兼容性测试
- 性能基准测试

### 安全测试
- 误报率测试
- 漏报率测试
- 检测覆盖率测试

## 性能考虑

### 优化策略
- **并行扫描**: 多文件并行检测
- **缓存机制**: 检测结果缓存
- **增量扫描**: 只扫描变更文件
- **资源限制**: 内存和CPU使用控制

### 性能指标
- 扫描速度: < 100ms/文件
- 内存使用: < 100MB
- 并发处理: 支持10+文件并行

## 风险评估

### 技术风险
- 误报率控制
- 性能影响评估
- 多语言支持复杂性

### 缓解措施
- 可配置的检测规则
- 渐进式功能启用
- 详细的排除机制

## 成功指标

### 功能指标
- 支持10+检测类型
- 误报率 < 5%
- 扫描速度可接受

### 质量指标
- 检测准确性 > 90%
- 报告完整性 > 95%
- 用户体验良好

## 后续扩展

### 短期扩展
- 更多编程语言支持
- 自定义检测规则
- IDE插件集成

### 长期扩展
- AI驱动的安全分析
- 自动修复建议
- 持续安全监控